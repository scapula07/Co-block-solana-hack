{"ast":null,"code":"import { Connection } from \"./core/connection.js\";\nimport { DEFAULT_POPUP_HEIGHT_PX, DEFAULT_POPUP_WIDTH_PX } from \"./core/constants.js\";\nimport { PopupEvent } from \"./core/types.js\";\nimport { openPopup, validateOrigin } from \"./core/utils.js\";\nexport class ConnectionManager {\n  constructor(platform) {\n    this.platform = platform;\n    this.connection = null;\n    this.popupWindow = null;\n    this.handleMessage = e => {\n      var _a, _b;\n      if (!validateOrigin(e.origin)) {\n        return;\n      }\n      const validatedOrigin = e.origin;\n      if (!this.popupWindow) {\n        return;\n      }\n      if (e.data.event === PopupEvent.HANDSHAKE && !this.connection) {\n        if (!this.verifyAndResetNonce((_a = e.data.payload) === null || _a === void 0 ? void 0 : _a.nonce)) {\n          return;\n        }\n        this.popupWindow.postMessage({\n          event: PopupEvent.HANDSHAKE_ACK,\n          payload: {\n            platform: this.platform\n          }\n        }, validatedOrigin);\n        this.connection = new Connection(validatedOrigin, this.popupWindow);\n        (_b = this.connectionUpdatedCallback) === null || _b === void 0 ? void 0 : _b.call(this, this.connection);\n      }\n      if (!this.connection) {\n        return;\n      }\n      this.connection.runHandlersForEvent(e.data.event, e.data.payload);\n      if (e.data.event === PopupEvent.POPUP_CLOSED && this.connection) {\n        this.resetConnection();\n        this.popupWindow = null;\n      }\n    };\n  }\n  initialize() {\n    window.addEventListener('message', this.handleMessage);\n    return this;\n  }\n  tearDown() {\n    window.removeEventListener('message', this.handleMessage);\n    this.resetConnection();\n    return this;\n  }\n  open(_ref) {\n    let {\n      url,\n      widthPx = DEFAULT_POPUP_WIDTH_PX,\n      heightPx = DEFAULT_POPUP_HEIGHT_PX,\n      nonce\n    } = _ref;\n    var _a;\n    if ((_a = this.popupWindow) === null || _a === void 0 ? void 0 : _a.closed) {\n      this.resetConnectionAndPopupWindow();\n    }\n    if (this.popupWindow) {\n      return;\n    }\n    this.initialize();\n    if (nonce) {\n      this.nonce = nonce;\n    }\n    const left = window.screenX + (window.innerWidth - widthPx) / 2;\n    const top = window.screenY + (window.innerHeight - heightPx) / 2;\n    this.popupWindow = openPopup({\n      height: heightPx,\n      left,\n      top,\n      url,\n      width: widthPx\n    });\n  }\n  close() {\n    if (!this.popupWindow) {\n      return;\n    }\n    this.popupWindow.close();\n    this.resetConnectionAndPopupWindow();\n  }\n  onConnectionUpdated(callback) {\n    this.connectionUpdatedCallback = callback;\n    return this;\n  }\n  getConnection() {\n    return this.connection;\n  }\n  resetConnectionAndPopupWindow() {\n    this.resetConnection();\n    this.popupWindow = null;\n  }\n  resetConnection() {\n    var _a, _b;\n    (_a = this.connection) === null || _a === void 0 ? void 0 : _a.resetHandlers();\n    this.connection = null;\n    (_b = this.connectionUpdatedCallback) === null || _b === void 0 ? void 0 : _b.call(this, this.connection);\n  }\n  verifyAndResetNonce(uncheckedNonce) {\n    if (!this.nonce) {\n      return true;\n    }\n    const result = uncheckedNonce === this.nonce;\n    if (result) {\n      this.nonce = undefined;\n    }\n    return result;\n  }\n}","map":{"version":3,"mappings":"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","names":["Connection","DEFAULT_POPUP_HEIGHT_PX","DEFAULT_POPUP_WIDTH_PX","PopupEvent","openPopup","validateOrigin","ConnectionManager","constructor","platform","e","origin","validatedOrigin","popupWindow","data","event","HANDSHAKE","connection","verifyAndResetNonce","payload","nonce","postMessage","HANDSHAKE_ACK","connectionUpdatedCallback","runHandlersForEvent","POPUP_CLOSED","resetConnection","initialize","window","addEventListener","handleMessage","tearDown","removeEventListener","open","url","widthPx","heightPx","closed","resetConnectionAndPopupWindow","left","screenX","innerWidth","top","screenY","innerHeight","height","width","close","onConnectionUpdated","callback","getConnection","resetHandlers","uncheckedNonce","result","undefined"],"sources":["../../src/connection-manager.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module","externalDependencies":[]}